<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ADËâØ‰º¥ - Beta</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root { 
            --gray: #8e8e93; --lightgreen: #98fb98; --brightorange: #ff8c00; --brightblue: #00bfff;
            --red: #ff3b30; --green: #34c759; --bg: #000; --card: #1c1c1e; --warning: #ffcc00;
        }
        body { background-color: var(--bg); color: #fff; font-family: -apple-system, sans-serif; margin: 0; padding: 10px; padding-bottom: 110px; }
        
        /* È†ÇÈÉ®Â∞éËà™ */
        .header-sticky { position: sticky; top: 0; background: var(--bg); z-index: 100; padding-bottom: 10px; border-bottom: 1px solid #333; }
        .concert-title { background: transparent; color: var(--brightblue); border: none; font-size: 1.5rem; font-weight: bold; width: 100%; margin: 8px 0; outline: none; }
        .info-bar { display: flex; justify-content: space-between; font-size: 0.8rem; color: #aaa; margin-bottom: 5px;}
        
        .status-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 5px; }
        .status-box { background: var(--card); padding: 10px; border-radius: 8px; text-align: center; border: 1px solid #333; }
        .status-label { font-size: 0.7rem; color: #888; display: block; margin-bottom: 3px; }
        .remaining { color: var(--brightorange); font-size: 1.4rem; font-family: monospace; font-weight: bold; }
        .safe-status { color: var(--green); font-weight: bold; font-size: 1.4rem; }
        .delay-status { color: var(--red); font-weight: bold; font-size: 1.4rem; animation: blink-text 0.6s infinite; }

        /* Âç°ÁâáÈ°èËâ≤ÈÄ£Âãï */
        .cue-card { background: var(--card); border-radius: 12px; padding: 12px; margin-bottom: 12px; border-left: 10px solid var(--gray); position: relative; transition: 0.3s; }
        .cue-card[data-type="song"] { border-left-color: var(--gray); }
        .cue-card[data-type="talking"] { border-left-color: var(--lightgreen); }
        .cue-card[data-type="vcr"] { border-left-color: var(--brightorange); }
        .cue-card[data-type="other"] { border-left-color: var(--brightblue); }
        
        .cue-card.active { background: #2c2c2e; outline: 1px solid #555; }
        .cue-card.is-locked { background: #111; opacity: 0.9; border-left-style: double; }

        .card-body { display: flex; justify-content: space-between; align-items: flex-start; gap: 15px; }
        .left-content { flex: 1; display: flex; flex-direction: column; gap: 6px; }
        .right-timers { text-align: right; min-width: 110px; display: flex; flex-direction: column; gap: 10px; padding-top: 5px; }

        .cue-name { background: #333; border: none; color: #fff; padding: 8px; border-radius: 4px; width: 100%; font-size: 1.1rem; box-sizing: border-box; }
        
        /* Á≠ÜË®òÊ¨ÑËá™ÂãïÂ¢ûÈ´ò */
        .cue-note { width: 100%; background: #252525; border: 1px dashed #444; color: #ccc; font-size: 0.9rem; padding: 8px; border-radius: 4px; outline: none; box-sizing: border-box; resize: none; overflow: hidden; line-height: 1.4; min-height: 40px; }
        .cue-note:focus { border-color: var(--brightblue); color: #fff; }

        .timer-val { font-family: 'Courier New', monospace; font-size: 1.4rem; font-weight: bold; display: block; line-height: 1; }
        .main-cd { color: #fff; }
        .cue-cd { color: var(--warning); margin-top: 2px; }
        .cue-cd-label { font-size: 0.75rem; color: var(--warning); display: block; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 110px; }
        
        .is-overrun { color: var(--red) !important; animation: blink-text 0.3s infinite; }
        .now-flash { color: var(--red); animation: blink-text 0.4s infinite; }
        .time-tag { color: var(--brightblue); font-family: monospace; font-size: 0.75rem; display: inline-block; margin-right: 10px; }

        .input-group { display: flex; align-items: center; justify-content: space-between; margin-top: 10px; border-top: 1px solid #333; padding-top: 10px; }
        .cue-duration { background: #333; border: none; color: #fff; padding: 8px; border-radius: 6px; width: 70px; text-align: center; font-family: monospace; font-size: 1rem; }
        .cue-duration:disabled { background: #222; color: #666; }

        .btn { border: none; border-radius: 8px; font-weight: bold; cursor: pointer; padding: 10px 14px; }
        .btn-start { background: var(--green); color: #fff; }
        .btn-start.running { animation: blink-green 1.2s infinite; }
        .btn-end:disabled { background: #444; color: #888; cursor: not-allowed; }
        
        .footer-tools { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.9); padding: 15px; display: flex; gap: 8px; backdrop-filter: blur(10px); z-index: 200; }
        .btn-add { background: var(--brightblue); color: white; flex: 2; font-size: 1rem; }
        .btn-tool { background: #333; color: #fff; flex: 1; }

        @keyframes blink-green { 0% { opacity: 1; } 50% { opacity: 0.2; } 100% { opacity: 1; } }
        @keyframes blink-text { 0% { opacity: 1; } 50% { opacity: 0.2; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div class="header-sticky">
    <input type="text" id="main-title" class="concert-title" value="ÊºîÂî±ÊúÉÂêçÁ®±" onchange="saveData()">
    <div class="info-bar">
        <span>ÁèæÂú® <b id="current-time">--:--:--</b></span>
        <span>ÁõÆÊ®ôÁµêÊùü <input type="time" id="target-end-time" value="22:00" onchange="recalculateAll(); saveData();" style="background:#333; color:#fff; border:none; border-radius:4px; padding:2px 5px;"></span>
    </div>
    
    <div class="status-grid">
        <div class="status-box">
            <span class="status-label">Ë∑ùÈõ¢ÁµêÊùüÂâ©È§ò</span>
            <span id="countdown" class="remaining">--:--:--</span>
        </div>
        <div class="status-box">
            <span class="status-label">ÂÖ®Â†¥Ë∂ÖÊôÇÁõ£Ê∏¨</span>
            <span id="offset-display" class="safe-status">Safe</span>
        </div>
    </div>
</div>

<div id="cue-list"></div>

<div class="footer-tools">
    <button class="btn btn-tool" onclick="resetData()">RESET</button>
    <button class="btn btn-add" onclick="addRow()">+ Êñ∞Â¢ûÈ†ÖÁõÆ</button>
    <button class="btn btn-tool" onclick="saveData()">SAVE</button>
</div>

<script>
    let songCountdowns = {}; 
    let actualStartTimes = {}; 
    let lastActiveId = null;

    Sortable.create(document.getElementById('cue-list'), { animation: 150, onEnd: () => { recalculateAll(); saveData(); } });

    function autoGrow(element) {
        element.style.height = "5px";
        element.style.height = (element.scrollHeight) + "px";
    }

    function updateClock() {
        const now = new Date();
        const ct = document.getElementById('current-time');
        if (ct) ct.innerText = now.toTimeString().split(' ')[0];
        const targetStr = document.getElementById('target-end-time').value;
        const target = new Date();
        const [h, m] = targetStr.split(':');
        target.setHours(h, m, 0);
        const diff = target - now;
        const cd = document.getElementById('countdown');
        if (diff > 0) {
            const hh = Math.floor(diff / 3600000).toString().padStart(2, '0');
            const mm = Math.floor((diff % 3600000) / 60000).toString().padStart(2, '0');
            const ss = Math.floor((diff % 60000) / 1000).toString().padStart(2, '0');
            cd.innerText = `${hh}:${mm}:${ss}`;
        } else { cd.innerText = "OVER TIME"; }
    }
    setInterval(updateClock, 1000);

    function addRow(data = null) {
        const id = data?.id || Date.now() + Math.random();
        const card = document.createElement('div');
        card.className = `cue-card ${data?.locked ? 'is-locked' : ''}`;
        card.id = `card-${id}`;
        card.setAttribute('data-type', data?.type || 'song');
        card.innerHTML = `
            <div class="card-body">
                <div class="left-content">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <span class="index-label" style="color:#666; font-size:0.9rem; font-weight:bold;"></span>
                        <input type="text" value="${data?.name || 'È†ÖÁõÆÂêçÁ®±'}" class="cue-name" onchange="saveData()">
                    </div>
                    <textarea class="cue-note" placeholder="Á≠ÜË®ò (‰æãÂ¶Ç 3:15 Âô¥ÂΩ©Â∏∂)" oninput="autoGrow(this); saveData();" onfocus="autoGrow(this)">${data?.note || ''}</textarea>
                    <div>
                        <span class="time-tag start-tag">Ëµ∑ --:--:--</span>
                        <span class="time-tag end-tag">ËøÑ --:--:--</span>
                    </div>
                </div>
                <div class="right-timers">
                    <div>
                        <span style="font-size:0.6rem; color:#888;">Á∏ΩÂâ©È§ò</span>
                        <span class="timer-val main-cd" id="cd-val-${id}">--:--</span>
                    </div>
                    <div id="cue-timers-container-${id}"></div>
                </div>
            </div>
            <div class="input-group">
                <div style="display:flex; align-items:center; gap:10px;">
                    <select class="type-select" onchange="updateCardType('${id}', this.value); saveData();" style="background:#333; color:#fff; border:none; padding:5px; border-radius:4px;">
                        <option value="song" ${data?.type==='song'?'selected':''}>Song</option>
                        <option value="talking" ${data?.type==='talking'?'selected':''}>Talking</option>
                        <option value="vcr" ${data?.type==='vcr'?'selected':''}>VCR</option>
                        <option value="other" ${data?.type==='other'?'selected':''}>Other</option>
                    </select>
                    <input type="text" value="${data?.duration || '05:00'}" class="cue-duration" id="dur-${id}" onchange="recalculateAll(); saveData();" ${data?.locked ? 'disabled' : ''}>
                </div>
                <div style="display:flex; gap:8px;">
                    <button class="btn btn-lock" style="background:none; color:#ff9500; font-size:1.2rem;" onclick="toggleLock('${id}')">${data?.locked ? 'üîí' : 'üîì'}</button>
                    <button class="btn btn-start" id="start-btn-${id}" onclick="triggerStart(this, '${id}')">START</button>
                    <button class="btn btn-end" id="end-btn-${id}" style="background:#444; color:#fff;" onclick="triggerEnd('${id}')" ${data?.locked ? 'disabled' : ''}>END</button>
                    <button class="btn" style="background:none; color:#444;" onclick="removeRow('${id}')">‚úï</button>
                </div>
            </div>
        `;
        document.getElementById('cue-list').appendChild(card);
        setTimeout(() => autoGrow(card.querySelector('.cue-note')), 50);
        recalculateAll();
    }

    function toggleLock(id) {
        const card = document.getElementById(`card-${id}`);
        const btn = card.querySelector('.btn-lock');
        const durInput = document.getElementById(`dur-${id}`);
        const endBtn = document.getElementById(`end-btn-${id}`);
        const isLocked = card.classList.toggle('is-locked');
        btn.innerText = isLocked ? 'üîí' : 'üîì';
        durInput.disabled = isLocked;
        endBtn.disabled = isLocked;
        saveData();
    }

    function updateCardType(id, type) {
        document.getElementById(`card-${id}`).setAttribute('data-type', type);
    }

    function triggerStart(btn, id) {
        if (lastActiveId && lastActiveId != id) triggerEnd(lastActiveId);
        lastActiveId = id;
        actualStartTimes[id] = new Date();
        document.querySelectorAll('.cue-card').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.btn-start').forEach(b => b.classList.remove('running'));
        document.getElementById(`card-${id}`).classList.add('active');
        btn.classList.add('running');
        startCountdown(id);
        recalculateAll();
    }

    function triggerEnd(id) {
        const card = document.getElementById(`card-${id}`);
        clearInterval(songCountdowns[id]);
        const sBtn = document.getElementById(`start-btn-${id}`);
        if(sBtn) sBtn.classList.remove('running');
        const ctContainer = document.getElementById(`cue-timers-container-${id}`);
        if(ctContainer) ctContainer.innerHTML = "";
        
        if (actualStartTimes[id] && !card.classList.contains('is-locked')) {
            const diffMs = new Date() - actualStartTimes[id];
            const m = Math.floor(diffMs / 60000).toString().padStart(2, '0');
            const s = Math.floor((diffMs % 60000) / 1000).toString().padStart(2, '0');
            document.getElementById(`dur-${id}`).value = `${m}:${s}`;
        }
        recalculateAll();
    }

    function startCountdown(id) {
        Object.keys(songCountdowns).forEach(key => clearInterval(songCountdowns[key]));
        const mainCd = document.getElementById(`cd-val-${id}`);
        const cueContainer = document.getElementById(`cue-timers-container-${id}`);
        const noteText = document.getElementById(`card-${id}`).querySelector('.cue-note').value;
        const totalSecs = parseDuration(document.getElementById(`dur-${id}`).value);
        let elapsed = 0; 
        const timePattern = /(\d{1,2})[:'"](\d{2})\s*([^\s\n\rÔºå„ÄÇ,]+)?/g;
        let cuePoints = [];
        let match;
        while ((match = timePattern.exec(noteText)) !== null) {
            cuePoints.push({ targetSec: parseInt(match[1]) * 60 + parseInt(match[2]), desc: match[3] || "Cue" });
        }
        songCountdowns[id] = setInterval(() => {
            elapsed++;
            let currentLeft = totalSecs - elapsed;
            let absSecs = Math.abs(currentLeft);
            mainCd.innerText = (currentLeft < 0 ? "-" : "") + `${Math.floor(absSecs / 60).toString().padStart(2, '0')}:${(absSecs % 60).toString().padStart(2, '0')}`;
            mainCd.className = "timer-val main-cd " + (currentLeft < 0 ? "is-overrun" : (currentLeft <= 10 ? "warn-10" : ""));
            let cueHtml = "";
            cuePoints.forEach(cp => {
                let diff = cp.targetSec - elapsed;
                if (diff > 0) cueHtml += `<div style="margin-bottom:8px;"><span class="cue-cd-label">${cp.desc}</span><span class="timer-val cue-cd">${Math.floor(diff/60)}:${(diff%60).toString().padStart(2,'0')}</span></div>`;
                else if (diff >= -3) cueHtml += `<div style="margin-bottom:8px;"><span class="cue-cd-label">${cp.desc}</span><span class="timer-val cue-cd now-flash">NOW!</span></div>`;
            });
            cueContainer.innerHTML = cueHtml;
        }, 1000);
    }

    function parseDuration(str) {
        const parts = str.split(':');
        return parts.length === 2 ? parseInt(parts[0]) * 60 + parseInt(parts[1]) : parseInt(parts[0]) * 60;
    }

    function recalculateAll() {
        const cards = document.querySelectorAll('.cue-card');
        let rollingStartTime = null;
        let foundActive = false;
        let finalEndTime = null;
        cards.forEach((card, index) => {
            card.querySelector('.index-label').innerText = index + 1 + ".";
            const id = card.id.replace('card-', '');
            if (card.classList.contains('active')) { rollingStartTime = actualStartTimes[id]; foundActive = true; }
            if (foundActive && rollingStartTime) {
                card.querySelector('.start-tag').innerText = "Ëµ∑ " + rollingStartTime.toTimeString().split(' ')[0];
                const dSec = parseDuration(document.getElementById(`dur-${id}`).value);
                const endTime = new Date(rollingStartTime.getTime() + dSec * 1000);
                card.querySelector('.end-tag').innerText = "ËøÑ " + endTime.toTimeString().split(' ')[0];
                rollingStartTime = endTime;
                finalEndTime = endTime;
            }
        });
        const offsetDisplay = document.getElementById('offset-display');
        const targetStr = document.getElementById('target-end-time').value;
        if (finalEndTime && targetStr) {
            const target = new Date();
            const [h, m] = targetStr.split(':');
            target.setHours(h, m, 0);
            const offsetMs = finalEndTime - target;
            if (offsetMs > 0) {
                const offMin = Math.floor(offsetMs / 60000).toString().padStart(2, '0');
                const offSec = Math.floor((offsetMs % 60000) / 1000).toString().padStart(2, '0');
                offsetDisplay.innerText = `Delay: -${offMin}:${offSec}`;
                offsetDisplay.className = "delay-status";
            } else {
                offsetDisplay.innerText = "Safe";
                offsetDisplay.className = "safe-status";
            }
        }
    }

    function saveData() {
        const data = { title: document.getElementById('main-title').value, target: document.getElementById('target-end-time').value, items: [] };
        document.querySelectorAll('.cue-card').forEach(card => {
            const id = card.id.replace('card-', '');
            data.items.push({ id: id, name: card.querySelector('.cue-name').value, type: card.getAttribute('data-type'), duration: document.getElementById(`dur-${id}`).value, note: card.querySelector('.cue-note').value, locked: card.classList.contains('is-locked') });
        });
        localStorage.setItem('concert_app_v11', JSON.stringify(data));
    }

    function loadData() {
        const raw = localStorage.getItem('concert_app_v11');
        if (raw) {
            const data = JSON.parse(raw);
            document.getElementById('main-title').value = data.title;
            document.getElementById('target-end-time').value = data.target;
            data.items.forEach(item => addRow(item));
        } else {
            for(let i=0; i<40; i++) addRow({ name: `È†ÖÁõÆ ${i+1}`, duration: "05:00" });
        }
    }

    function resetData() { if(confirm("Á¢∫ÂÆöÈáçË®≠Ôºü")) { localStorage.clear(); location.reload(); } }
    function removeRow(id) { if(confirm("Á¢∫ÂÆöÂà™Èô§Ôºü")) { document.getElementById(`card-${id}`).remove(); recalculateAll(); saveData(); } }

    loadData();
</script>

</body>
</html>