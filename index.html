<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ADËâØ‰º¥ V2.1</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root { 
            --gray: #8e8e93; --lightgreen: #98fb98; --brightorange: #ff8c00; --brightblue: #00bfff;
            --red: #ff3b30; --green: #34c759; --bg: #000; --card: #1c1c1e; --warning: #ffcc00;
            --dim-green: #2d4a35;
        }
        body { background-color: var(--bg); color: #fff; font-family: -apple-system, sans-serif; margin: 0; padding: env(safe-area-inset-top) 10px calc(env(safe-area-inset-bottom) + 110px) 10px; user-select: none; }
        .header-sticky { position: sticky; top: 0; background: var(--bg); z-index: 100; padding-bottom: 10px; border-bottom: 1px solid #333; }
        .concert-title { background: transparent; color: var(--brightblue); border: none; font-size: 1.5rem; font-weight: bold; width: 100%; margin: 8px 0; outline: none; }
        .info-bar { display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; color: #aaa; margin-bottom: 5px;}
        
        .sort-toggle { display: flex; align-items: center; gap: 5px; background: #222; padding: 6px 12px; border-radius: 20px; border: 1px solid #444; color: #fff; cursor: pointer; }
        .sort-toggle.unlocked { background: var(--brightorange); color: #000; font-weight: bold; }

        .status-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 5px; }
        .status-box { background: var(--card); padding: 10px; border-radius: 8px; text-align: center; border: 1px solid #333; }
        .status-label { font-size: 0.7rem; color: #888; display: block; margin-bottom: 3px; }
        .remaining { color: var(--brightorange); font-size: 1.4rem; font-family: monospace; font-weight: bold; }

        .cue-card { background: var(--card); border-radius: 12px; padding: 12px; margin-bottom: 14px; border-left: 10px solid var(--gray); position: relative; transition: 0.4s; }
        .cue-card[data-type="song"] { border-left-color: var(--gray); background: rgba(142, 142, 147, 0.25); }
        .cue-card[data-type="talking"] { border-left-color: var(--lightgreen); background: rgba(152, 251, 152, 0.25); }
        .cue-card[data-type="vcr"] { border-left-color: var(--brightorange); background: rgba(255, 140, 0, 0.3); }
        .cue-card[data-type="other"] { border-left-color: var(--brightblue); background: rgba(0, 191, 255, 0.3); }
        
        .cue-card.active { outline: 2px solid #fff; box-shadow: 0 0 20px rgba(255,255,255,0.15); }
        .cue-card.is-skipped { opacity: 0.2; background: #111 !important; border-left-color: #333 !important; }

        /* ÊéíÂ∫èÊâãÊüÑË¶ñË¶∫ */
        .drag-handle { display: none; margin-right: 8px; color: #aaa; font-size: 1.4rem; cursor: grab; padding: 4px; }
        body.can-sort .drag-handle { display: inline-block; }

        .card-row-top { display: flex; gap: 10px; align-items: flex-start; }
        .left-info { flex: 1; min-width: 0; }
        .right-clock { width: 130px; text-align: right; flex-shrink: 0; display: flex; flex-direction: column; gap: 8px; }
        
        .timer-val { font-family: 'Courier New', monospace; font-size: 1.8rem; font-weight: bold; color: #fff; line-height: 1; }
        .cue-big-num { font-family: 'Courier New', monospace; font-size: 1.8rem; font-weight: bold; color: var(--warning); line-height: 1; display: block; }
        .cue-label-small { font-size: 0.65rem; color: var(--warning); opacity: 0.8; white-space: nowrap; }

        .index-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .index-label { font-family: monospace; font-size: 0.9rem; font-weight: 900; background: rgba(0,0,0,0.5); padding: 4px 8px; border-radius: 4px; color: #fff; min-width: 45px; text-align: center; }
        .time-marker-group { display: flex; gap: 4px; }
        .time-marker { font-family: monospace; font-size: 0.7rem; color: var(--brightblue); background: rgba(0, 191, 255, 0.1); padding: 2px 4px; border-radius: 4px; border: 1px solid rgba(0, 191, 255, 0.3); white-space: nowrap; }

        .cue-name { background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); color: #fff; padding: 8px; border-radius: 4px; width: 100%; font-size: 1.1rem; box-sizing: border-box; outline: none; }
        .cue-note { width: 100%; background: rgba(0,0,0,0.3); border: 1px dashed rgba(255,255,255,0.2); color: #ccc; font-size: 0.9rem; padding: 8px; border-radius: 4px; outline: none; box-sizing: border-box; resize: none; overflow: hidden; margin-top: 8px; min-height: 45px;}

        .duration-picker { display: flex; align-items: center; background: #222; border: 1px solid #666; border-radius: 8px; padding: 0 4px; }
        .time-input-mix { background: transparent; color: #fff; border: none; font-size: 1.1rem; font-family: monospace; outline: none; width: 35px; text-align: center; padding: 8px 0; font-weight: bold; }
        .time-input-mix:disabled { color: #555; }

        .type-select { background: #222; color: #fff; border: 1px solid #666; padding: 8px 4px; border-radius: 8px; font-size: 0.85rem; appearance: none; -webkit-appearance: none; outline: none; }
        
        .controls-row { display: flex; justify-content: space-between; align-items: center; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px; margin-top: 10px; }
        .btn { border: none; border-radius: 6px; font-weight: bold; cursor: pointer; padding: 10px 8px; font-size: 0.8rem; }
        .btn-start { background-color: var(--dim-green); color: #888; min-width: 55px; }
        .btn-start.running { background-color: var(--green); color: #fff; animation: blink-green 1.2s infinite; }
        .btn-end { background: #444; color: #fff; min-width: 45px; }
        .btn-end.ended { animation: pulse-red 2s infinite; background-color: var(--red); color: white; }

        @keyframes blink-green { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
        @keyframes pulse-red { 0% { background-color: #801010; } 50% { background-color: #ff3b30; } 100% { background-color: #801010; } }
        @keyframes blink-text { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div class="header-sticky">
    <input type="text" id="main-title" class="concert-title" value="ÊºîÂî±ÊúÉÂêçÁ®±" oninput="saveData()">
    <div class="info-bar">
        <span>ÁèæÂú® <b id="current-time">--:--:--</b></span>
        <div id="sort-toggle-btn" class="sort-toggle" onclick="toggleGlobalSort()">
            <span id="sort-icon">üîí</span> <span id="sort-text">ÊéíÂ∫èÈéñÂÆö</span>
        </div>
        <span>ÁõÆÊ®ô <input type="time" id="target-end-time" value="22:00" oninput="updateClock(); recalculateAll(); saveData();" style="background:#333; color:#fff; border:none; border-radius:4px; padding:2px 5px; width:70px;"></span>
    </div>
    <div class="status-grid">
        <div class="status-box"><span class="status-label">Ë∑ùÈõ¢ÁµêÊùü</span><span id="countdown" class="remaining">--:--:--</span></div>
        <div class="status-box"><span class="status-label">ÂÖ®Â†¥Ë∂ÖÊôÇ</span><span id="offset-display" style="color:var(--green); font-weight:bold; font-size:1.4rem;">Safe</span></div>
    </div>
</div>

<div id="cue-list"></div>

<div class="footer-tools" style="position:fixed; bottom:0; width:100%; display:flex; gap:8px; padding:15px; background:rgba(0,0,0,0.95); box-sizing:border-box; z-index:200; backdrop-filter: blur(10px);">
    <button class="btn" style="background:#333; color:#fff; flex:1;" onclick="resetData()">RESET</button>
    <button class="btn btn-add" style="background:var(--brightblue); color:#fff; flex:2; font-size:1.1rem; border-radius:10px;" onclick="addRow()">+ Êñ∞Â¢ûÈ†ÖÁõÆ</button>
    <button class="btn" id="save-hint-btn" style="background:var(--brightorange); color:#fff; flex:1;" onclick="manualSave()">SAVE</button>
</div>

<script>
    let songCountdowns = {}; let actualStartTimes = {}; let lastActiveId = null;
    let globalSortEnabled = false; let sortInstance;
    const CURRENT_STORAGE_KEY = 'concert_app_v44';

    setInterval(updateClock, 1000);

    function initSortable() {
        const el = document.getElementById('cue-list');
        if (sortInstance) sortInstance.destroy();
        sortInstance = Sortable.create(el, { 
            animation: 150, 
            handle: '.drag-handle', 
            disabled: !globalSortEnabled, 
            onEnd: () => { recalculateAll(); saveData(); } 
        });
    }

    function toggleGlobalSort() {
        globalSortEnabled = !globalSortEnabled;
        if(sortInstance) sortInstance.option("disabled", !globalSortEnabled);
        document.body.classList.toggle('can-sort', globalSortEnabled);
        const btn = document.getElementById('sort-toggle-btn');
        btn.classList.toggle('unlocked', globalSortEnabled);
        document.getElementById('sort-icon').innerText = globalSortEnabled ? 'üîì' : 'üîí';
        document.getElementById('sort-text').innerText = globalSortEnabled ? 'ÂÖÅË®±ÊéíÂ∫è' : 'ÊéíÂ∫èÈéñÂÆö';
        saveData();
    }

    function autoGrow(el) { if(!el) return; el.style.height = "5px"; el.style.height = (el.scrollHeight) + "px"; }

    function addRow(data = null) {
        const id = data?.id || Date.now() + Math.random();
        const card = document.createElement('div');
        card.className = `cue-card ${data?.locked ? 'is-locked' : ''} ${data?.skipped ? 'is-skipped' : ''}`;
        card.id = `card-${id}`; card.setAttribute('data-type', data?.type || 'song');

        let initialMin = data?.duration ? data.duration.split(':')[0] : "05";
        let initialSec = data?.duration ? data.duration.split(':')[1] : "00";

        card.innerHTML = `
            <div class="card-row-top">
                <div class="left-info">
                    <div class="index-row">
                        <span class="drag-handle">‚ò∞</span>
                        <span class="index-label"></span>
                        <div class="time-marker-group">
                            <span class="time-marker start-tag">S: --:--:--</span>
                            <span class="time-marker end-tag">E: --:--:--</span>
                        </div>
                    </div>
                    <input type="text" value="${data?.name || 'È†ÖÁõÆÂêçÁ®±'}" class="cue-name" oninput="saveData()">
                    <textarea class="cue-note" placeholder="00:00 Á≠ÜË®ò" oninput="autoGrow(this); saveData();" onfocus="autoGrow(this)">${data?.note || ''}</textarea>
                </div>
                <div class="right-clock">
                    <div>
                        <span id="cd-val-${id}" class="timer-val">--:--</span>
                        <div style="font-size:0.5rem; color:#888; letter-spacing:1px;">LEFT</div>
                    </div>
                    <div id="cue-timers-container-${id}"></div>
                </div>
            </div>

            <div class="controls-row">
                <div style="display:flex; align-items:center; gap:5px;">
                    <select class="type-select" onchange="updateCardType('${id}', this.value); recalculateAll();">
                        <option value="song" ${data?.type==='song'?'selected':''}>Song</option>
                        <option value="talking" ${data?.type==='talking'?'selected':''}>Talk</option>
                        <option value="vcr" ${data?.type==='vcr'?'selected':''}>VCR</option>
                        <option value="other" ${data?.type==='other'?'selected':''}>Other</option>
                    </select>
                    <div class="duration-picker">
                        <input type="number" class="time-input-mix min-input" value="${initialMin}" oninput="recalculateAll(); saveData();" ${data?.locked ? 'disabled' : ''}>
                        <span style="color:#666; font-weight:bold;">:</span>
                        <input type="number" class="time-input-mix sec-input" value="${initialSec}" oninput="recalculateAll(); saveData();" ${data?.locked ? 'disabled' : ''}>
                    </div>
                    <button class="btn" style="background:none; color:#ff9500; font-size:1.2rem; padding:0 2px;" onclick="toggleLock('${id}')" id="lock-btn-${id}">${data?.locked ? 'üîí' : 'üîì'}</button>
                </div>
                <div style="display:flex; gap:5px;">
                    <button class="btn btn-start" id="start-btn-${id}" onclick="triggerStart(this, '${id}')">START</button>
                    <button class="btn btn-end" id="end-btn-${id}" onclick="triggerEnd('${id}')">END</button>
                    <button class="btn" style="background:none; font-size:1.1rem; padding:0 2px;" onclick="toggleSkip('${id}')">üö´</button>
                    <button class="btn" style="background:none; color:#555; padding:0 2px;" onclick="removeRow('${id}')">‚úï</button>
                </div>
            </div>`;
        
        document.getElementById('cue-list').appendChild(card);
        setTimeout(() => autoGrow(card.querySelector('.cue-note')), 50);
        recalculateAll();
    }

    function triggerStart(btn, id) { 
        if (lastActiveId && lastActiveId != id) triggerEnd(lastActiveId); 
        lastActiveId = id; actualStartTimes[id] = new Date(); 
        document.querySelectorAll('.cue-card').forEach(c => c.classList.remove('active')); 
        document.querySelectorAll('.btn-start').forEach(b => b.classList.remove('running')); 
        document.querySelectorAll('.btn-end').forEach(b => b.classList.remove('ended')); 
        document.getElementById(`card-${id}`).classList.add('active'); 
        btn.classList.add('running'); 
        startCountdown(id); 
        recalculateAll();
    }

    function startCountdown(id) {
        Object.keys(songCountdowns).forEach(key => clearInterval(songCountdowns[key]));
        const card = document.getElementById(`card-${id}`);
        const mainCd = document.getElementById(`cd-val-${id}`);
        const cueContainer = document.getElementById(`cue-timers-container-${id}`);
        const noteText = card.querySelector('.cue-note').value;
        const timePattern = /(\d{1,2})[:'"](\d{2})\s*([^\s\n\rÔºå„ÄÇ,]+)?/g; 
        let cuePoints = []; let match;
        while ((match = timePattern.exec(noteText)) !== null) { 
            cuePoints.push({ targetSec: parseInt(match[1]) * 60 + parseInt(match[2]), desc: (match[3] || "CUE") }); 
        }
        
        songCountdowns[id] = setInterval(() => {
            const m = parseInt(card.querySelector('.min-input').value) || 0;
            const s = parseInt(card.querySelector('.sec-input').value) || 0;
            const totalSecs = m * 60 + s;
            const elapsed = Math.floor((new Date() - actualStartTimes[id]) / 1000);
            let left = totalSecs - elapsed;
            mainCd.innerText = (left < 0 ? "-" : "") + `${Math.floor(Math.abs(left)/60).toString().padStart(2, '0')}:${(Math.abs(left)%60).toString().padStart(2, '0')}`;
            mainCd.style.color = left < 0 ? "var(--red)" : (left <= 10 ? "var(--warning)" : "#fff");

            let cueHtml = "";
            cuePoints.forEach(cp => {
                let d = cp.targetSec - elapsed;
                if (d > 0) {
                    cueHtml += `<div style="margin-top:5px;"><div class="cue-label-small">${cp.desc}</div><span class="cue-big-num">${Math.floor(d/60)}:${(d%60).toString().padStart(2,'0')}</span></div>`;
                }
            });
            cueContainer.innerHTML = cueHtml;
            recalculateAll();
        }, 1000);
    }

    function triggerEnd(id) { 
        const card = document.getElementById(`card-${id}`);
        if(!card) return;
        clearInterval(songCountdowns[id]); 
        document.getElementById(`start-btn-${id}`).classList.remove('running'); 
        document.getElementById(`end-btn-${id}`).classList.add('ended'); 
        if (actualStartTimes[id] && !card.classList.contains('is-locked')) { 
            const totalSecs = Math.floor((new Date() - actualStartTimes[id]) / 1000);
            card.querySelector('.min-input').value = Math.floor(totalSecs / 60).toString().padStart(2, '0');
            card.querySelector('.sec-input').value = (totalSecs % 60).toString().padStart(2, '0');
        } 
        recalculateAll(); saveData(); 
    }

    function recalculateAll() {
        const cards = document.querySelectorAll('.cue-card'); 
        let rollingStartTime = null, foundActive = false, finalEndTime = null;
        let counters = { song: 0, talking: 0, vcr: 0, other: 0 };
        const prefix = { song: 'S', talking: 'T', vcr: 'V', other: 'O' };

        cards.forEach((card) => {
            const id = card.id.replace('card-', '');
            const type = card.getAttribute('data-type');
            const isSkipped = card.classList.contains('is-skipped');
            if (!isSkipped) { 
                counters[type]++; 
                card.querySelector('.index-label').innerText = `${prefix[type]}-${counters[type]}`; 
            } else { card.querySelector('.index-label').innerText = `--`; }

            const dSec = isSkipped ? 0 : (parseInt(card.querySelector('.min-input').value || 0) * 60 + parseInt(card.querySelector('.sec-input').value || 0));
            const sTag = card.querySelector('.start-tag'); const eTag = card.querySelector('.end-tag');

            if (card.classList.contains('active')) { 
                const actualStart = actualStartTimes[id];
                sTag.innerText = "S: " + actualStart.toTimeString().split(' ')[0];
                const expectedEnd = new Date(actualStart.getTime() + dSec * 1000);
                eTag.innerText = "E: " + expectedEnd.toTimeString().split(' ')[0];
                rollingStartTime = expectedEnd; foundActive = true; 
            } else if (foundActive) {
                sTag.innerText = isSkipped ? "S: SKIP" : "S: " + rollingStartTime.toTimeString().split(' ')[0];
                const endTime = new Date(rollingStartTime.getTime() + dSec * 1000);
                eTag.innerText = isSkipped ? "E: SKIP" : "E: " + endTime.toTimeString().split(' ')[0];
                rollingStartTime = endTime; finalEndTime = endTime;
            } else { sTag.innerText = "S: --:--:--"; eTag.innerText = "E: --:--:--"; }
        });

        if (finalEndTime) {
            const targetStr = document.getElementById('target-end-time').value;
            const target = new Date(); const [h, m] = targetStr.split(':'); target.setHours(parseInt(h), parseInt(m), 0, 0);
            const diff = finalEndTime - target;
            const off = document.getElementById('offset-display');
            if(diff > 0) { off.innerText = `Delay: -${Math.floor(diff/60000)}:${Math.floor((diff%60000)/1000).toString().padStart(2,'0')}`; off.style.color = "var(--red)"; }
            else { off.innerText = "Safe"; off.style.color = "var(--green)"; }
        }
    }

    function updateClock() { const now = new Date(); document.getElementById('current-time').innerText = now.toTimeString().split(' ')[0]; const targetStr = document.getElementById('target-end-time').value; if (targetStr) { const [h, m] = targetStr.split(':'); const target = new Date(); target.setHours(parseInt(h), parseInt(m), 0, 0); if (target < now && (now - target) < 43200000) {} else if (target < now) { target.setDate(target.getDate() + 1); } const diff = target - now; const cdDisplay = document.getElementById('countdown'); if (diff > 0) { const hh = Math.floor(diff / 3600000).toString().padStart(2, '0'); const mm = Math.floor((diff % 3600000) / 60000).toString().padStart(2, '0'); const ss = Math.floor((diff % 60000) / 1000).toString().padStart(2, '0'); cdDisplay.innerText = `${hh}:${mm}:${ss}`; cdDisplay.style.color = "var(--brightorange)"; } else { cdDisplay.innerText = "OVER TIME"; cdDisplay.style.color = "var(--red)"; } } }
    function updateCardType(id, type) { document.getElementById(`card-${id}`).setAttribute('data-type', type); saveData(); }
    function manualSave() { saveData(); const btn = document.getElementById('save-hint-btn'); btn.innerText = "SAVED!"; setTimeout(() => btn.innerText = "SAVE", 1500); }
    function resetData() { if(confirm("Á¢∫ÂÆöÈáçË®≠Ôºü")) { localStorage.clear(); location.reload(); } }
    function removeRow(id) { if(confirm("Á¢∫ÂÆöÂà™Èô§Ôºü")) { document.getElementById(`card-${id}`).remove(); recalculateAll(); saveData(); } }

    function saveData() {
        const data = { title: document.getElementById('main-title').value, target: document.getElementById('target-end-time').value, items: [] };
        document.querySelectorAll('.cue-card').forEach(card => {
            const id = card.id.replace('card-', '');
            data.items.push({ id: id, name: card.querySelector('.cue-name').value, type: card.getAttribute('data-type'), duration: `${card.querySelector('.min-input').value}:${card.querySelector('.sec-input').value}`, note: card.querySelector('.cue-note').value, locked: card.classList.contains('is-locked'), skipped: card.classList.contains('is-skipped') });
        });
        localStorage.setItem(CURRENT_STORAGE_KEY, JSON.stringify(data));
    }
    
    function loadData() {
        const list = document.getElementById('cue-list'); list.innerHTML = "";
        let raw = localStorage.getItem(CURRENT_STORAGE_KEY) || localStorage.getItem('concert_app_v43');
        if (raw) {
            const data = JSON.parse(raw); document.getElementById('main-title').value = data.title; document.getElementById('target-end-time').value = data.target;
            data.items.forEach(item => addRow(item));
        } else { for(let i=0; i<5; i++) addRow(); }
        initSortable();
    }
    
    window.onload = loadData;
</script>
</body>
</html>